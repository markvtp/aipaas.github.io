
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>优化的聊天页面</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#165DFF',
                    },
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    
    <style type="text/tailwindcss">
        @layer utilities {
            .content-auto {
                content-visibility: auto;
            }
            .chat-fullscreen {
                height: calc(100vh - 4rem);
            }
            @media (max-width: 360px) {
                .chat-fullscreen {
                    height: calc(100vh - 3.5rem);
                }
            }
            @media (min-width: 768px) {
                .chat-fullscreen {
                    height: calc(100vh - 4.5rem);
                }
            }
            .frame-container {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }
            .iframe-wrapper {
                min-width: 300px; /* 确保移动设备上的最小宽度 */
                max-width: 800px; /* 限制最大宽度，避免过宽 */
                margin: 0 auto; /* 居中显示 */
            }
        }
    </style>
</head>
<body class="bg-gray-50 overflow-hidden text-gray-800">
    <!-- 顶部导航栏 -->
    <header class="bg-primary text-white shadow-md z-10">
        <div class="container mx-auto px-4 py-3 flex items-center justify-between">
            <h1 class="text-lg font-semibold flex items-center">
                <i class="fa fa-comments-o mr-2"></i>
                <span>聊天界面</span>
            </h1>
            <div class="flex items-center space-x-3">
                <button id="refreshBtn" class="p-2 hover:bg-primary-700 rounded-full transition-colors">
                    <i class="fa fa-refresh"></i>
                </button>
                <button id="fullscreenBtn" class="p-2 hover:bg-primary-700 rounded-full transition-colors">
                    <i class="fa fa-expand"></i>
                </button>
            </div>
        </div>
    </header>

    <!-- 主要聊天区域 -->
    <main class="relative w-full chat-fullscreen bg-gray-100 overflow-hidden z-0">
        <!-- 加载指示器 -->
        <div id="loader" class="absolute inset-0 flex items-center justify-center bg-white z-20">
            <div class="flex flex-col items-center">
                <div class="w-10 h-10 border-4 border-primary border-t-transparent rounded-full animate-spin"></div>
                <p class="mt-3 text-gray-600">加载中...</p>
            </div>
        </div>
        
        <!-- 聊天页面容器 - 添加了滚动容器以处理缩放后的内容 -->
        <div class="frame-container w-full h-full p-1">
            <div class="iframe-wrapper relative w-full h-full">
                <iframe 
                    id="chatFrame" 
                    src="https://14.116.240.82:1453/chat/Kr17mLEiTY6oyCHM2sYHgw" 
                    class="w-full h-full border-0 transform transition-transform duration-200 ease-in-out"
                    sandbox="allow-same-origin allow-scripts allow-popups allow-forms"
                    onload="hideLoader()"
                ></iframe>
            </div>
        </div>
    </main>

    <!-- 底部操作栏 -->
    <footer class="bg-white border-t border-gray-200 py-2 z-10">
        <div class="container mx-auto px-4">
            <div class="flex items-center justify-between text-sm text-gray-500">
                <button id="zoomOutBtn" class="p-2 hover:bg-gray-100 rounded transition-colors">
                    <i class="fa fa-search-minus"></i> 缩小
                </button>
                <button id="zoomInBtn" class="p-2 hover:bg-gray-100 rounded transition-colors">
                    <i class="fa fa-search-plus"></i> 放大
                </button>
                <button id="fitBtn" class="p-2 hover:bg-gray-100 rounded transition-colors">
                    <i class="fa fa-compress"></i> 适应屏幕
                </button>
            </div>
        </div>
    </footer>

    <script>
        // 全局变量
        let currentZoom = 1.0;
        const zoomStep = 0.1;
        const minZoom = 0.7; // 提高最小缩放比例，避免过度缩小
        const maxZoom = 1.3; // 适当降低最大缩放比例
        const baseWidth = 800; // 基准宽度，用于计算容器宽度
        
        // DOM元素
        const chatFrame = document.getElementById('chatFrame');
        const loader = document.getElementById('loader');
        const refreshBtn = document.getElementById('refreshBtn');
        const fullscreenBtn = document.getElementById('fullscreenBtn');
        const zoomInBtn = document.getElementById('zoomInBtn');
        const zoomOutBtn = document.getElementById('zoomOutBtn');
        const fitBtn = document.getElementById('fitBtn');
        const frameContainer = document.querySelector('.frame-container');
        const iframeWrapper = document.querySelector('.iframe-wrapper');
        
        // 隐藏加载指示器
        function hideLoader() {
            loader.classList.add('opacity-0', 'pointer-events-none');
            setTimeout(() => {
                loader.classList.add('hidden');
            }, 500);
        }
        
        // 刷新iframe
        refreshBtn.addEventListener('click', () => {
            loader.classList.remove('hidden', 'opacity-0', 'pointer-events-none');
            chatFrame.src = chatFrame.src;
        });
        
        // 全屏切换
        fullscreenBtn.addEventListener('click', () => {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen().catch(err => {
                    alert(`全屏切换错误: ${err.message}`);
                });
                fullscreenBtn.innerHTML = '<i class="fa fa-compress"></i>';
            } else {
                if (document.exitFullscreen) {
                    document.exitFullscreen();
                    fullscreenBtn.innerHTML = '<i class="fa fa-expand"></i>';
                }
            }
        });
        
        // 放大功能
        zoomInBtn.addEventListener('click', () => {
            if (currentZoom < maxZoom) {
                currentZoom += zoomStep;
                applyZoom();
            }
        });
        
        // 缩小功能
        zoomOutBtn.addEventListener('click', () => {
            if (currentZoom > minZoom) {
                currentZoom -= zoomStep;
                applyZoom();
            }
        });
        
        // 适应屏幕
        fitBtn.addEventListener('click', () => {
            currentZoom = 1.0;
            applyZoom();
        });
        
        // 应用缩放 - 优化版本
        function applyZoom() {
            // 计算基于当前缩放的容器宽度
            const containerWidth = baseWidth * currentZoom;
            iframeWrapper.style.width = `${containerWidth}px`;
            
            // 重置transform，使用宽度缩放代替transform缩放
            chatFrame.style.transform = 'none';
            chatFrame.style.width = '100%';
            chatFrame.style.height = '100%';
            
            // 滚动到内容中心（如果需要）
            setTimeout(() => {
                const scrollPos = (iframeWrapper.offsetWidth - frameContainer.offsetWidth) / 2;
                frameContainer.scrollLeft = scrollPos;
            }, 100);
        }
        
        // 监听窗口大小变化，重新调整
        window.addEventListener('resize', () => {
            applyZoom();
        });
        
        // 尝试自动调整原页面元素
        function adjustIframeContent() {
            try {
                // 获取iframe中的文档
                const iframeDoc = chatFrame.contentDocument || chatFrame.contentWindow.document;
                
                // 如果有权限访问iframe内容，则进行调整
                if (iframeDoc) {
                    // 添加视口元标签（如果不存在）
                    let viewportMeta = iframeDoc.querySelector('meta[name="viewport"]');
                    if (!viewportMeta) {
                        viewportMeta = iframeDoc.createElement('meta');
                        viewportMeta.name = 'viewport';
                        iframeDoc.head.appendChild(viewportMeta);
                    }
                    viewportMeta.content = 'width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no';
                    
                    // 尝试调整聊天区域大小和样式
                    const chatContainers = iframeDoc.querySelectorAll('.chat-container, .message-container, .conversation-container');
                    chatContainers.forEach(container => {
                        container.style.maxWidth = '100%';
                        container.style.width = '100%';
                        container.style.minWidth = '300px'; // 设置最小宽度
                    });
                    
                    // 调整消息气泡样式，确保比例
                    const messageBubbles = iframeDoc.querySelectorAll('.message-bubble, .chat-message');
                    messageBubbles.forEach(bubble => {
                        bubble.style.maxWidth = '85%'; // 消息气泡最大宽度限制
                        bubble.style.minWidth = 'auto';
                    });
                    
                    // 移除可能导致滚动的元素的固定高度
                    const fixedHeightElements = iframeDoc.querySelectorAll('[style*="height: 100%"], [style*="height: 600px"]');
                    fixedHeightElements.forEach(el => {
                        el.style.height = 'auto';
                        el.style.minHeight = '100%';
                    });
                }
            } catch (e) {
                // 跨域访问可能会失败，这里静默处理
                console.log('无法调整iframe内容，可能存在跨域限制');
            }
        }
        
        // 页面加载完成后尝试调整
        window.addEventListener('load', () => {
            // 初始化缩放
            applyZoom();
            // 延迟执行，确保iframe内容已加载
            setTimeout(adjustIframeContent, 2000);
        });
    </script>
</body>
</html>
